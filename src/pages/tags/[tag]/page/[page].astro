---
import Layout from '@layouts/Layout.astro';
import PostCard from '@components/post/PostCard.astro';
import Pagination from '@components/common/Pagination.astro';
import { envConfig, siteConfig } from '@config';
import {
  keyToSlug,
  getTaxonomyLabel,
  getTaxonomyDescription
} from '@utils/taxonomyUtils';
import { resolveUrl } from '@utils/pathUtils';
import { CollectionUtils, PostUtils } from "@utils/collectionUtils";
import type { CollectionEntry } from "astro:content";
import type { GetStaticPathsOptions, GetStaticPathsResult, Page } from "astro";


export async function getStaticPaths({ paginate }: GetStaticPathsOptions): Promise<GetStaticPathsResult> {
  const { content: contentConfig } = siteConfig;
  // 获取所有标签及其对应的文章
  const sortedTagPostMapping: Map<string, CollectionEntry<"posts">[]> = await new CollectionUtils("posts")
    .filter(PostUtils.filterNotDraft)
    .sortBy(PostUtils.compareByDateDesc)
    .groupBelongTo(PostUtils.tags);

  let paths: GetStaticPathsResult = [];
  for (const [tagKey, tagPosts] of sortedTagPostMapping) {
    const slug = await keyToSlug("tags", tagKey);

    // Paginate paths for each category
    const tagPaths = paginate(tagPosts, {
      pageSize: contentConfig.postsPerPage,
      params: { tag: slug },
      props: { tagKey }
    });

    paths = paths.concat(tagPaths);
  }
  return paths;
}

interface Props {
  // @Reference https://docs.astro.build/zh-cn/reference/routing-reference/#paginate
  page: Page<CollectionEntry<"posts">>;
  tagKey: string;
}

const { public: publicConfig } = envConfig;
const { tagKey, page } = Astro.props;
const {
  data: currentPosts,
  currentPage,
  lastPage: totalPages,
  url: { prev: prevUrl, next: nextUrl },
} = page;
const basePath = resolveUrl('./', publicConfig.PUBLIC_BASE_URL, Astro.url.pathname);


// Get current locale
// @astro-ignore
const currentLocale = Astro.locals.lang;

// Get localized label and description
const tagLabel = await getTaxonomyLabel('tags', tagKey, currentLocale);
const tagDescription = await getTaxonomyDescription('tags', tagKey, currentLocale);

// SEO meta data
const pageTitle = currentLocale === 'en'
  ? `Tag: ${tagLabel} - Page ${currentPage}` 
  : `标签：${tagLabel} - 第${currentPage}页`;
const pageDescription = tagDescription || 
  (currentLocale === 'en'
    ? `Articles tagged with ${tagLabel} - Page ${currentPage}`
    : `标签为 ${tagLabel} 的文章 - 第${currentPage}页`);
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  noindex={true}
>
  <div class="w-full py-8">
    <header class="mb-10">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
        {currentLocale === 'en' ? `Tag: #${tagLabel}` : `标签：#${tagLabel}`}
      </h1>
      {tagDescription && (
        <p class="text-lg text-gray-600 dark:text-gray-400 mb-4">
          {tagDescription}
        </p>
      )}
      <p class="text-lg text-gray-700 dark:text-gray-300">
        {currentLocale === 'en'
          ? `Page ${currentPage} of ${totalPages}`
          : `第 ${currentPage} 页，共 ${totalPages} 页`}
      </p>
    </header>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {currentPosts.map((post) => (
        <PostCard post={post} />
      ))}
    </div>
    
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      prevUrl={prevUrl}
      nextUrl={nextUrl}
      basePath={basePath}
    />
  </div>
</Layout>
